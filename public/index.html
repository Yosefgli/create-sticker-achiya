<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generate PDF (Client) → Send Base64 to Webhook</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f6f6f6; }

    /* ===== LABEL (100x100mm) ===== */
    #label{
      width: 100mm;
      height: 100mm;
      background: #fff;
      border: 2px solid #000;
      box-sizing: border-box;
      padding: 8mm;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 4mm;
      position: relative;

      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .brand{
      text-align: center;
      padding-bottom: 3mm;
      border-bottom: 2px solid #000;
    }

    .brand .title{
      margin: 0;
      font-size: 22pt;
      line-height: 1.05;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .brand .subtitle{
      margin-top: 2mm;
      font-size: 12.5pt;
      line-height: 1.15;
      font-weight: 700;
    }

    .meta{
      display: grid;
      grid-template-columns: 1fr;
      gap: 3.2mm;
      margin-top: 2mm;
    }

    .card{
      border: 2px solid #000;
      padding: 4mm;
      display: grid;
      gap: 3mm;
    }

    .row{
      display: grid;
      grid-template-columns: 22mm 1fr;
      gap: 2mm;
      align-items: baseline;
      font-size: 12pt;
    }

    .lbl{
      font-weight: 800;
      white-space: nowrap;
    }

    .val{
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .footer{
      border-top: 2px solid #000;
      padding-top: 3mm;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4mm;
      font-size: 10.5pt;
      font-weight: 700;
    }

    .small{
      font-size: 10pt;
      font-weight: 700;
      opacity: .95;
      white-space: nowrap;
    }

    /* ===== UI controls ===== */
    .controls { margin-top: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    input { padding: 8px 10px; font-size: 14px; width: 220px; }
    .status { margin-top: 12px; font-size: 14px; white-space: pre-wrap; }
    .hint { font-size: 12px; color: #333; margin-top: 8px; max-width: 900px; line-height: 1.4; }
    code { background: #eee; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>

  <!-- ===== LABEL VIEW ===== -->
  <div id="label">
    <div class="brand">
      <h1 class="title">ברכת האדמה</h1>
      <div class="subtitle">חקלאות עברית מהשדה עד לבית</div>
    </div>

    <div class="meta">
      <div class="card">
        <div class="row">
          <div class="lbl">מוצר:</div>
          <div class="val" id="pName">חלה</div>
        </div>
        <div class="row">
          <div class="lbl">תאריך:</div>
          <div class="val" id="pDate">2026-02-10</div>
        </div>
        <div class="row">
          <div class="lbl">אצווה:</div>
          <div class="val" id="pBatch">000123</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small">100×100 מ״מ</div>
      <div class="small">הדפסה שחור-לבן</div>
    </div>
  </div>

  <!-- ===== CONTROLS ===== -->
  <div class="controls">
    <input id="nameInput" placeholder="שם מוצר" value="חלה" />
    <input id="dateInput" placeholder="תאריך" value="2026-02-10" />
    <input id="batchInput" placeholder="אצווה" value="000123" />
    <button id="btnSend">צור PDF ושלח לוובהוק</button>
    <button id="btnDownload" type="button">צור PDF והורד (בדיקה)</button>
  </div>

  <div class="hint">
    שים לב: שליחה ישירה מהדפדפן לוובהוק בדומיין אחר יכולה להיחסם ע"י CORS.
    בקוד הזה יש 2 מצבים:
    <br>1) <b>Send (no-cors)</b> — שולח בלי לקבל תשובה.
    <br>2) Download — לוודא שה-PDF נוצר תקין.
    <br><br>
    החלף את <code>WEBHOOK_URL</code> לכתובת הוובהוק שלך.
  </div>

  <div class="status" id="status"></div>

  <script>
    // ✅ החלף לכתובת ה-webhook שלך (Make / Boost / וכו')
    const WEBHOOK_URL = "https://hook.integrator.boost.space/q78rwd42j34fi2nyhj5hguj6xlug3e5q";

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    function updateLabelFromInputs() {
      document.getElementById("pName").textContent = document.getElementById("nameInput").value || "";
      document.getElementById("pDate").textContent = document.getElementById("dateInput").value || "";
      document.getElementById("pBatch").textContent = document.getElementById("batchInput").value || "";
    }

    function safeSlug(s) {
      return (s || "")
        .trim()
        .replace(/[^\w\u0590-\u05FF\- ]+/g, "")
        .replace(/\s+/g, "-")
        .slice(0, 50) || "label";
    }

    async function generatePdfBase64FromElement(el) {
      // טיפ קטן: scale גבוה => חד יותר, אבל קובץ גדול יותר
      const scale = 2;

      const canvas = await html2canvas(el, {
        backgroundColor: "#ffffff",
        scale,
        useCORS: true
      });

      // PNG שומר חדות לטקסט יותר מ-JPEG (למדבקות זה בדרך כלל עדיף)
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: [100, 100] // 100x100mm
      });

      pdf.addImage(imgData, "PNG", 0, 0, 100, 100);

      // data:application/pdf;base64,....
      const dataUriString = pdf.output("datauristring");
      return dataUriString.split(",")[1];
    }

    async function sendPdfBase64ToWebhookNoCors(pdfBase64, fileName, meta) {
      const payload = {
        fileName,
        mimeType: "application/pdf",
        pdfBase64,
        meta
      };

      await fetch(WEBHOOK_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=UTF-8"
        },
        body: JSON.stringify(payload)
      });
    }

    function downloadBase64Pdf(pdfBase64, filename) {
      const byteChars = atob(pdfBase64);
      const byteNumbers = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
      const byteArray = new Uint8Array(byteNumbers);
      const blob = new Blob([byteArray], { type: "application/pdf" });

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById("btnSend").addEventListener("click", async () => {
      try {
        if (!WEBHOOK_URL || WEBHOOK_URL.includes("PASTE_YOUR")) {
          setStatus("שים את כתובת הוובהוק בתוך WEBHOOK_URL בקוד.");
          return;
        }

        updateLabelFromInputs();
        setStatus("מייצר PDF...");

        const el = document.getElementById("label");
        const pdfBase64 = await generatePdfBase64FromElement(el);

        const product = safeSlug(document.getElementById("nameInput").value);
        const fileName = `label-100x100-${product}.pdf`;

        const meta = {
          product: document.getElementById("nameInput").value,
          date: document.getElementById("dateInput").value,
          batch: document.getElementById("batchInput").value,
          generatedAt: new Date().toISOString()
        };

        setStatus(
          "PDF נוצר. שולח לוובהוק (no-cors)...\n" +
          "שים לב: אין תשובה מהשרת בדפדפן. תבדוק בצד הוובהוק אם התקבל.\n" +
          `Base64 length: ${pdfBase64.length}`
        );

        await sendPdfBase64ToWebhookNoCors(pdfBase64, fileName, meta);

        setStatus(
          "הבקשה נשלחה מהדפדפן.\n" +
          "אם הוובהוק לא מקבל — כנראה פורמט/כותרות/Proxy.\n"
        );
      } catch (e) {
        setStatus("שגיאה:\n" + (e?.message || e));
      }
    });

    document.getElementById("btnDownload").addEventListener("click", async () => {
      try {
        updateLabelFromInputs();
        setStatus("מייצר PDF להורדה...");

        const el = document.getElementById("label");
        const pdfBase64 = await generatePdfBase64FromElement(el);

        const product = safeSlug(document.getElementById("nameInput").value);
        const fileName = `label-100x100-${product}.pdf`;

        downloadBase64Pdf(pdfBase64, fileName);
        setStatus(`ה-PDF נוצר וירד למחשב: ${fileName}\nBase64 length: ${pdfBase64.length}`);
      } catch (e) {
        setStatus("שגיאה:\n" + (e?.message || e));
      }
    });
  </script>
</body>
</html>
